Код подрефакторил. Вынес в хуки большую часть логики. Функционал работает. 
